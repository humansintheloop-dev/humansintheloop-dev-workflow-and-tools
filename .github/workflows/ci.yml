name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run ruff check
        run: uv run --with ruff ruff check

      - name: Run pyright
        run: uvx pyright --level error src/

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: shellcheck test-scripts/*.sh

      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.24.2/gitleaks_8.24.2_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks
        run: gitleaks detect --source . --verbose

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Run plugin JavaScript tests
        run: ./test-scripts/test-plugin-javascript.sh

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Run tests
        run: ./test-scripts/test-end-to-end.sh

  integration-gh:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Configure git to use gh for authentication
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: gh auth setup-git

      - name: Run integration_gh tests
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TEST_ORG: ${{ secrets.GH_TEST_ORG }}
        run: uv run --python 3.12 python3 -m pytest tests/ -v -m integration_gh
